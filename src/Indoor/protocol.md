# 快应用 - WebView 双向通信协议

## 约定

* `Hap`前缀的信号方向为`快应用->Web`

* `Web`前缀的信号方向为`Web->快应用`


## 协议细节

### 通用返回信号

### HapReady 

快应用已加载完成Web

### Hap2D

快应用要求切换至2D模式

### Hap3D

快应用要求切换至3D模式

### HapF{n}

切换到n楼层 地上n为正值，地下n为负值

### 高级信号

#### `Hap{type:type, detail:detail}`

高级信号将参数一并发送至Web侧，实现与Web的实时通信

#### 同步位置

从相机位置到地图位置

```json
{
  	type: 'loc',
  	detail: {
      x: x,
      y: y,
      floorNum: floorNum
    }
}
```

#### 路径规划

```json
{
		type: 'navi',
  	detail: [{
      				x: 100,
      				y: 100,
      				fnum: 1
    				},
            {
              x: 100,
              y: 100,
              fnum: 1,
            },
            {
              ...
            }]
}
```

#### 导航（Pending）

```json
{
  type: 'navi',
  detail: [{
    nodeObject
  }, {
    
  }, {
    
  }]
}
```

#### 搜索店铺

```json
{
  type: 'search',
  detail: {
    nodeType : 元素类型,可选。
    name : 元素name,可选。
    keyword : 关键词查询,可选。
    ID : 元素ID,可选。
    FloorNum : 元素所属楼层,可选。与第一步骤中queryFloors作用一样,但此处只能指定单个楼层
    typeID : 元素所属分类ID,可选。    
    types : 检索的图层类型。如不指定，默认检索地图所有类型的图层。默认值:(esmap.ESLayerType)
  }
}
```

#### 热力图

* 应用热力图

```json
{
  type: 'applyHeatMap'
}
```

* 移除热力图

```json
{
  type: 'removeHeatMap'
}
```

热力图同步通过web端的websocket进行



导航

首先用户搜索一个店的信息，然后点击搜索结果项，地图会生成从当前位置到这个店的路线，这个过程是：

拿到这个店的信息，将ID发给后端进行路径规划，拿到路线后画在地图上。



Websocket建立连接

```json
{
  request: 'open',
  options: {
    interval: 1000,
    floorNum: 1
  }
}
```

onmessage去用addPoints处理热力图数据更新

```json
{
  request: 'switch',
  options: {
    floorNum: 2,
  }
}
```





```json
{
  floorNum: 1,
  data: [
    {x:13496140.383561742,y:3640230.05635368,value:10},
    {x:13496140.383561742,y:3640230.05635368,value:10},
    {x:13496140.383561742,y:3640230.05635368,value:10}
  ]
}
```



## 待完成需求

### 点击地图展示商店信息栏 完成

用户点击地图上的房间，地图移动到那个建筑周围，并将信息发送给快应用，快应用收到后起一个新的底栏展示这个信息。

底栏展示信息时，若用户点击地面，则信息底栏消失，展示功能底栏。

底栏展示信息时，若用户点击其他房间，则直接显示另一个商店的信息。

* 商店信息栏应该包含
  * 商店名称
  * 商店位置
  * 商店距离用户多远
  * 导航按钮
  * 分享按钮
  * 关闭

### 导航需求 5小时

用户点击搜索框，功能底栏消失，展示搜索工具底栏，搜索工具底栏要求

> 当前进度： 搜索交互做出来了

* 上方是搜索框，输入后点击搜索按钮展示搜索结果
* 未输入时展示历史记录
* 搜索结果项左边是文字 右边是路线
  * 用户点击搜索结果 地图聚集到用户点的这个店的位置 并展示商店信息栏
  * 用户点击路线按钮 请求路线 并在地图上画出路线 展示商店信息栏
* 用户可以点击商店信息栏的导航按钮进行导航 ✅
* 用户也可以点击分享按钮分享这家店

### 用户位置需求 

* 向web侧更新用户位置
* 用户可以主动点击按钮更新位置
  * 需要做一个按钮

> 需要获取设备的方向 已解决✅

现在的方案，待确认：

测试环境默认随机一个点，然后方向基于真实的方向动态更新。

开发环境默认只使用一个蓝牙进行定位，即搜到哪个用哪个作为当前，方向是根据罗盘。

生产环境使用三个蓝牙基于RSSI的定位模式，精确计算用户位置。



## TODO 04/19

* 完成搜索UI和逻辑
* 完成路线生成
* 完成导航功能
* 完成附近UI和功能 优先度

| 任务     | 内容                                                         | 优先级 | 完成情况 |
| -------- | ------------------------------------------------------------ | ------ | -------- |
| 搜索UI   | 搜索框的UI包括输入，包括结果展示 包括结果的UI，以及点击的交互 | 高     | 完成     |
| 搜索逻辑 | 搜索输入后，在下方异步展示答案，显示效果UI完成               | 高     | 完成     |
| 路线生成 | 实现请求后的多点路径规划                                     | 紧急   | 完成     |
| 导航     | 路径规划并开始导航                                           | 高     | 完成     |
| 附近UI   | 附近Tab内的UI设计和填充                                      | 低     |          |

## Bug

| 需求 | 问题                                                 | 问题源头                                                     | 解决程度 |
| ---- | ---------------------------------------------------- | ------------------------------------------------------------ | -------- |
| 导航 | 点击导航如果用户与所点击位置偏差比较远会无法同步过去 | 当前的模拟环境导致位置一直是中心点，实际情况模拟导航必定是从人所在位置到终点，因此应该会自然解决。除此以外问题是esmap导致的。 | 解决     |
| 导航 | 部分点无法导航                                       |                                                              |          |
|      |                                                      |                                                              |          |
|      |                                                      |                                                              |          |





## 协议新增

### 返回属性

返回属性是指向快应用的，用于更新快应用的UI

```json
{
  type: 'ret',
  detail: '2D'||'3D'||'Fn'||"HeatMap"||'Map'||"..."
}
```

不同于发送给快应用的其他msg，返回属性只针对于UI的同步。

### 聚焦

```json
{
  type: 'focus',
  detail: id
}
```





### 导航栏

专门的导航栏，防止用户在导航时误操作

### 导航描述同步协议

```json
{
  type: 'naviDesc',
  detail: {
    desc: '', //当前环节描述字符串
    next: '', //下一个环节的desc,如果没有下一个就直接默认 `您已到达目的地`
    time: '0', //所耗时间 超过60s为minutes 
    remain: '10M' //剩余距离
  }
}
```





```sequence

```

